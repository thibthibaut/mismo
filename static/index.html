<!-- index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mismo</title>
  <style>
    /* Reset some default styles */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Helvetica Neue', sans-serif;
      background: linear-gradient(135deg, #f06, #f79);
      color: #333;
      text-align: center;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    h1 {
      color: #fff;
      font-size: 3em;
      margin-bottom: 20px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    button {
      background: #00C853;
      border: none;
      padding: 12px 24px;
      color: #fff;
      font-size: 1em;
      cursor: pointer;
      margin: 10px;
      border-radius: 6px;
      transition: background 0.3s ease;
    }

    button:hover {
      background: #00B44A;
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    input[type="text"], input[type="number"] {
      padding: 10px;
      font-size: 1em;
      border: 2px solid #ccc;
      border-radius: 4px;
      margin: 10px 0;
      width: 80%;
      max-width: 300px;
    }

    /* Sections */
    .section {
      display: none;
      background: rgba(255, 255, 255, 0.9);
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      width: 90%;
      max-width: 500px;
      animation: fadeIn 0.5s ease-in-out;
    }

    .visible {
      display: block;
    }

    /* Player List */
    .playerList {
      margin: 20px 0;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
    }

    .player {
      background: #e0f7fa;
      margin: 5px;
      padding: 10px 15px;
      border-radius: 6px;
      min-width: 120px;
      position: relative;
      transition: background 0.3s ease, color 0.3s ease;
    }

    .player.eliminated {
      background: #ffebee;
      color: #b71c1c;
      text-decoration: line-through;
    }

    .lives {
      font-weight: bold;
      margin-top: 5px;
    }

    /* Round Results */
    #roundResults {
      margin-top: 20px;
      padding: 15px;
      background: #fff3e0;
      border: 1px solid #ffcc80;
      border-radius: 6px;
      display: none;
      animation: fadeIn 0.5s ease-in-out;
    }

    /* Game Over */
    #gameOverSection {
      display: none;
      background: #fff3e0;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      animation: fadeIn 0.5s ease-in-out;
    }

    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Responsive */
    @media (max-width: 600px) {
      .player {
        min-width: 100px;
        padding: 8px 10px;
      }

      button {
        padding: 10px 20px;
        font-size: 0.9em;
      }

      input[type="text"], input[type="number"] {
        width: 90%;
      }
    }
  </style>
</head>
<body>
  <h1>Mismo</h1>

  <!-- Landing Page -->
  <div id="landingPage" class="section visible">
    <button id="startGameBtn">Start a Game</button>
    <button id="joinGameBtn">Join a Game</button>
  </div>

  <!-- Start Game Form -->
  <div id="startGameForm" class="section">
    <h2>Start a New Game</h2>
    <input type="text" id="hostName" placeholder="Your Name" />
    <button id="createGameBtn">Create Game</button>
    <button id="backFromStartBtn">Back</button>
  </div>

  <!-- Join Game Form -->
  <div id="joinGameForm" class="section">
    <h2>Join an Existing Game</h2>
    <input type="text" id="joinGameID" placeholder="Game ID" />
    <input type="text" id="joinName" placeholder="Your Name" />
    <button id="joinBtn">Join</button>
    <button id="backFromJoinBtn">Back</button>
  </div>

  <!-- Waiting Room -->
  <div id="waitingRoom" class="section">
    <h2>Waiting Room</h2>
    <p>Game ID: <strong id="displayGameID"></strong></p>
    <div class="playerList" id="waitingPlayers"></div>
    <p id="waitingMessage">Waiting for at least 3 players...</p>
    <button id="startGameNowBtn" style="background:#ff9800; display: none;">Start Game</button>
  </div>

  <!-- Game Screen -->
  <div id="gameScreen" class="section">
    <h2>Game ID: <span id="gameIDSpan"></span></h2>
    <h3>Players</h3>
    <div class="playerList" id="playerList"></div>

    <!-- Submit Number Section -->
    <div id="submitSection">
      <h3>Submit Your Number</h3>
      <input type="number" id="numberInput" min="0" placeholder="Enter a number" />
      <button id="submitNumberBtn">Submit</button>
    </div>

    <!-- Round Results -->
    <div id="roundResults">
      <h3>Round Results</h3>
      <p id="resultsText"></p>
    </div>

    <!-- Next Round Button -->
    <button id="nextRoundBtn" style="background:#673ab7; display: none;">Next Round</button>
  </div>

  <!-- Game Over Section -->
  <div id="gameOverSection" class="section">
    <h2>Game Over!</h2>
    <p>Winner: <strong id="winnerName"></strong></p>
    <button id="restartBtn">Play Again</button>
  </div>

  <script>
    // Game State Variables
    let currentGameID = null;
    let currentPlayerID = null;
    let isHost = false;
    let gameOver = false;
    let socket = null;

    // Section Elements
    const sections = {
      landingPage: document.getElementById('landingPage'),
      startGameForm: document.getElementById('startGameForm'),
      joinGameForm: document.getElementById('joinGameForm'),
      waitingRoom: document.getElementById('waitingRoom'),
      gameScreen: document.getElementById('gameScreen'),
      gameOverSection: document.getElementById('gameOverSection')
    };

    // Buttons
    const startGameBtn = document.getElementById('startGameBtn');
    const joinGameBtn = document.getElementById('joinGameBtn');
    const backFromStartBtn = document.getElementById('backFromStartBtn');
    const backFromJoinBtn = document.getElementById('backFromJoinBtn');
    const createGameBtn = document.getElementById('createGameBtn');
    const joinBtn = document.getElementById('joinBtn');
    const startGameNowBtn = document.getElementById('startGameNowBtn');
    const submitNumberBtn = document.getElementById('submitNumberBtn');
    const nextRoundBtn = document.getElementById('nextRoundBtn');
    const restartBtn = document.getElementById('restartBtn');

    // Input Fields
    const hostNameInput = document.getElementById('hostName');
    const joinGameIDInput = document.getElementById('joinGameID');
    const joinNameInput = document.getElementById('joinName');
    const numberInput = document.getElementById('numberInput');

    // Display Elements
    const displayGameID = document.getElementById('displayGameID');
    const waitingPlayers = document.getElementById('waitingPlayers');
    const waitingMessage = document.getElementById('waitingMessage');
    const gameIDSpan = document.getElementById('gameIDSpan');
    const playerList = document.getElementById('playerList');
    const submitSection = document.getElementById('submitSection');
    const roundResults = document.getElementById('roundResults');
    const resultsText = document.getElementById('resultsText');
    const winnerName = document.getElementById('winnerName');

    // Section Navigation Functions
    function showSection(section) {
      Object.values(sections).forEach(sec => sec.classList.remove('visible'));
      section.classList.add('visible');
    }

    // Event Listeners for Navigation
    startGameBtn.addEventListener('click', () => showSection(sections.startGameForm));
    joinGameBtn.addEventListener('click', () => showSection(sections.joinGameForm));
    backFromStartBtn.addEventListener('click', () => showSection(sections.landingPage));
    backFromJoinBtn.addEventListener('click', () => showSection(sections.landingPage));
    restartBtn.addEventListener('click', () => location.reload());

    // Create a New Game
    createGameBtn.addEventListener('click', async () => {
      const hostName = hostNameInput.value.trim();
      if (!hostName) {
        alert('Please enter your name.');
        return;
      }

      try {
        const response = await fetch('/create-game', {
          method: 'POST',
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(errorText || 'Failed to create game.');
        }

        const data = await response.json();
        currentGameID = data.gameId;
        isHost = true;

        if (!currentGameID) {
          throw new Error('Invalid response from server.');
        }

        // Update UI
        displayGameID.textContent = currentGameID;
        showSection(sections.waitingRoom);
        connectWebSocket(hostName);
      } catch (error) {
        console.error('Create Game Error:', error);
        alert(`Error: ${error.message}`);
      }
    });

    // Join an Existing Game
    joinBtn.addEventListener('click', async () => {
      const gameID = joinGameIDInput.value.trim();
      const playerName = joinNameInput.value.trim();

      if (!gameID || !playerName) {
        alert('Please enter both Game ID and your name.');
        return;
      }

      try {
        currentGameID = gameID;
        isHost = false;
        showSection(sections.waitingRoom);
        connectWebSocket(playerName);
      } catch (error) {
        console.error('Join Game Error:', error);
        alert(`Error: ${error.message}`);
      }
    });

    // Connect to WebSocket
    function connectWebSocket(playerName) {
      socket = new WebSocket(`ws://${window.location.host}/ws/game/${currentGameID}`);

      socket.onopen = () => {
        // Send join message
        socket.send(JSON.stringify({ type: "join", name: playerName }));
      };

      socket.onmessage = (event) => {
        const data = JSON.parse(event.data);
        handleGameState(data);
      };

      socket.onclose = () => {
        console.log('WebSocket connection closed.');
      };

      socket.onerror = (error) => {
        console.error('WebSocket error:', error);
      };
    }

    // Handle incoming game state
    function handleGameState(state) {
      const { id, state: gameState, round, players, gameOver, winner } = state;

      // Update game ID display
      displayGameID.textContent = id;
      gameIDSpan.textContent = id;

      // Update player lists
      updatePlayerList(players, 'waitingPlayers', 'waiting');
      updatePlayerList(players, 'playerList', 'game');

      // Handle game states
      if (gameState === "waiting") {
        showSection(sections.waitingRoom);
        if (isHost && Object.keys(players).length >= 3) {
          startGameNowBtn.style.display = 'inline-block';
        } else {
          startGameNowBtn.style.display = 'none';
        }
      } else if (gameState === "playing") {
        showSection(sections.gameScreen);
        submitSection.style.display = 'block';
        roundResults.style.display = 'none';
        nextRoundBtn.style.display = 'none';
      } else if (gameState === "roundEnd") {
        showSection(sections.gameScreen);
        submitSection.style.display = 'none';
        roundResults.style.display = 'block';
        nextRoundBtn.style.display = isHost ? 'inline-block' : 'none';
        generateRoundResults(state);
      } else if (gameState === "gameOver") {
        showSection(sections.gameOverSection);
        winnerName.textContent = winner || 'No one';
      }
    }

    // Update Player List in the UI
    function updatePlayerList(players, elementId, context) {
      const container = document.getElementById(elementId);
      container.innerHTML = '';

      for (const pid in players) {
        const pl = players[pid];
        const playerDiv = document.createElement('div');
        playerDiv.classList.add('player');
        if (pl.lives <= 0) {
          playerDiv.classList.add('eliminated');
        }

        const nameDiv = document.createElement('div');
        nameDiv.textContent = pl.name;

        const livesDiv = document.createElement('div');
        livesDiv.classList.add('lives');
        livesDiv.textContent = `${pl.lives} ${pl.lives === 1 ? 'life' : 'lives'}`;

        playerDiv.appendChild(nameDiv);
        playerDiv.appendChild(livesDiv);

        container.appendChild(playerDiv);
      }
    }

    // Start the Game (Host)
    startGameNowBtn.addEventListener('click', () => {
      if (socket && isHost) {
        socket.send(JSON.stringify({ type: "start" }));
      }
    });

    // Submit a Number
    submitNumberBtn.addEventListener('click', () => {
      const numberValue = numberInput.value.trim();

      if (numberValue === '') {
        alert('Please enter a number.');
        return;
      }

      const num = Number(numberValue);
      if (isNaN(num) || num < 0 || !Number.isInteger(num)) {
        alert('Please enter a valid non-negative integer.');
        return;
      }

      if (socket) {
        socket.send(JSON.stringify({ type: "number", number: num }));
        submitSection.style.display = 'none';
      }
    });

    // Next Round (Host)
    nextRoundBtn.addEventListener('click', () => {
      if (socket && isHost) {
        socket.send(JSON.stringify({ type: "nextRound" }));
      }
    });

    // Generate Round Results
    function generateRoundResults(state) {
      const { players } = state;
      let min = Infinity;
      let max = -Infinity;
      const numberCounts = {};

      // Determine min and max numbers and count occurrences
      for (const pid in players) {
        const pl = players[pid];
        if (pl.lives <= 0 || pl.number === undefined) continue;
        const num = pl.number;
        if (num < min) min = num;
        if (num > max) max = num;

        if (numberCounts[num]) {
          numberCounts[num].push(pl.name);
        } else {
          numberCounts[num] = [pl.name];
        }
      }

      // Identify players with min and max numbers
      const minPlayers = [];
      const maxPlayers = [];

      for (const pid in players) {
        const pl = players[pid];
        if (pl.lives <= 0 || pl.number === undefined) continue;
        if (pl.number === min) minPlayers.push(pl.name);
        if (pl.number === max) maxPlayers.push(pl.name);
      }

      let message = '';

      if (minPlayers.length > 0) {
        message += `Lowest Number (${min}): ${minPlayers.join(', ')} lose a life.<br/>`;
      }

      if (maxPlayers.length > 0) {
        message += `Highest Number (${max}): ${maxPlayers.join(', ')} lose a life.<br/>`;
      }

      // Handle "Mismo" situations
      for (const num in numberCounts) {
        if (numberCounts[num].length === 2) {
          message += `Mismo! Players with number ${num} (${numberCounts[num].join(', ')}) are eliminated.<br/>`;
        }
      }

      resultsText.innerHTML = message || 'No changes this round.';
    }
  </script>
</body>
</html>
